# Linux 进阶指南：文件系统、进程管理与日志系统

## 目录

1. [文件系统管理](#文件系统管理)
   - [基本概念](#基本概念)
   - [文件系统操作](#文件系统操作)
   - [挂载与管理](#挂载与管理)
   - [高级文件系统管理](#高级文件系统管理)
2. [进程管理](#进程管理)
   - [进程基础](#进程基础)
   - [进程监控与控制](#进程监控与控制)
   - [服务管理](#服务管理)
   - [资源限制与优先级](#资源限制与优先级)
3. [日志系统](#日志系统)
   - [journalctl (systemd)](#journalctl-systemd)
   - [传统 syslog](#传统-syslog)
   - [日志轮转](#日志轮转)
   - [日志分析与故障排查](#日志分析与故障排查)
4. [实战场景](#实战场景)

## 文件系统管理

### 基本概念

Linux 文件系统是一个树状结构，以根目录(`/`)为起点。

#### 关键目录及其用途

```bash
# 查看根目录结构
ls -l /

# 主要目录解释
# /bin    - 基本命令二进制文件
# /boot   - 引导加载程序文件
# /dev    - 设备文件
# /etc    - 系统配置文件
# /home   - 用户主目录
# /lib    - 库文件
# /media  - 可移动媒体挂载点
# /mnt    - 临时挂载点
# /opt    - 可选软件包
# /proc   - 进程和内核信息
# /root   - root用户主目录
# /run    - 运行时变量数据
# /sbin   - 系统二进制文件
# /srv    - 服务数据
# /sys    - 系统信息
# /tmp    - 临时文件
# /usr    - 用户程序
# /var    - 可变数据文件
```

#### 查看文件系统类型和使用情况

```bash
# 显示文件系统使用情况
df -h

# 显示文件系统类型
df -T

# 查看特定目录的磁盘使用情况
du -sh /var/log

# 查看目录中各个子目录的大小
du -h --max-depth=1 /var
```

### 文件系统操作

#### 文件系统基本操作

```bash
# 创建目录
mkdir -p /path/to/new/directory

# 创建文件
touch newfile.txt
echo "Hello World" > newfile.txt

# 复制文件
cp source.txt destination.txt
# 递归复制目录及其内容
cp -r source_dir/ destination_dir/

# 移动/重命名文件
mv oldname.txt newname.txt
mv file.txt /path/to/destination/

# 删除文件和目录
rm file.txt
# 递归删除目录
rm -r directory/
# 强制递归删除（谨慎使用）
rm -rf directory/

# 创建符号链接
ln -s /path/to/target linkname
```

#### 查找文件

```bash
# 按名称查找
find /home -name "*.txt"

# 按类型查找（f=文件，d=目录）
find /etc -type f -name "*.conf"

# 按修改时间查找（7天内修改的）
find /var/log -type f -mtime -7

# 按大小查找（大于100MB的文件）
find / -type f -size +100M

# 按权限查找
find /bin -perm 755

# 查找并执行操作
find /tmp -name "*.tmp" -exec rm {} \;
```

#### 文件权限与特殊权限

```bash
# 修改文件权限
chmod 644 file.txt   # rw-r--r--
chmod 755 script.sh  # rwxr-xr-x

# 使用符号表示法
chmod u+x script.sh  # 给所有者添加执行权限
chmod g+w file.txt   # 给组添加写权限
chmod o-rwx file.txt # 删除其他人的所有权限

# 修改所有权
chown user:group file.txt

# 递归修改目录及其内容的所有权
chown -R user:group directory/

# 设置特殊权限
# SUID - 执行时具有文件所有者权限
chmod u+s executable
# SGID - 在目录中创建的文件继承目录组
chmod g+s directory/
# Sticky Bit - 只有文件所有者能删除文件
chmod +t directory/
```

### 挂载与管理

#### 磁盘分区与格式化

```bash
# 查看磁盘和分区
lsblk
fdisk -l

# 使用fdisk创建分区
sudo fdisk /dev/sdb
# 在fdisk交互界面中:
# 输入'n'创建新分区
# 输入'w'写入更改并退出

# 格式化为ext4文件系统
sudo mkfs.ext4 /dev/sdb1

# 格式化为XFS文件系统
sudo mkfs.xfs /dev/sdb2
```

#### 挂载文件系统

```bash
# 临时挂载
sudo mount /dev/sdb1 /mnt/mydisk

# 查看当前挂载的文件系统
mount
cat /proc/mounts

# 卸载文件系统
sudo umount /mnt/mydisk
# 或
sudo umount /dev/sdb1

# 设置开机自动挂载（编辑/etc/fstab）
sudo nano /etc/fstab
# 添加以下行:
# /dev/sdb1 /mnt/mydisk ext4 defaults 0 2

# 挂载所有/etc/fstab中的设备
sudo mount -a
```

#### 查看和管理挂载点

```bash
# 查看挂载的文件系统类型和选项
findmnt

# 挂载特定类型的所有文件系统
sudo mount -t ext4 -a

# 以只读方式重新挂载文件系统
sudo mount -o remount,ro /dev/sda1
```

### 高级文件系统管理

#### 逻辑卷管理 (LVM)

```bash
# 安装LVM工具
sudo apt install lvm2  # Ubuntu/Debian
sudo yum install lvm2  # CentOS/RHEL

# 创建物理卷(PV)
sudo pvcreate /dev/sdb1 /dev/sdc1

# 查看物理卷
sudo pvs
sudo pvdisplay

# 创建卷组(VG)
sudo vgcreate myvg /dev/sdb1 /dev/sdc1

# 查看卷组
sudo vgs
sudo vgdisplay

# 创建逻辑卷(LV)
sudo lvcreate -L 10G -n mylv myvg

# 查看逻辑卷
sudo lvs
sudo lvdisplay

# 格式化逻辑卷
sudo mkfs.ext4 /dev/myvg/mylv

# 挂载逻辑卷
sudo mkdir /mnt/lvm
sudo mount /dev/myvg/mylv /mnt/lvm

# 扩展逻辑卷
sudo lvextend -L +5G /dev/myvg/mylv
sudo resize2fs /dev/myvg/mylv  # 对ext文件系统调整大小
```

#### 文件系统检查与修复

```bash
# 检查ext4文件系统（不修复，需要卸载）
sudo umount /dev/sdb1
sudo fsck /dev/sdb1

# 强制检查并修复
sudo fsck -f /dev/sdb1

# 检查XFS文件系统
sudo xfs_repair /dev/sdb2

# 查看和修改文件系统参数（ext系列）
sudo tune2fs -l /dev/sdb1
sudo tune2fs -c 30 /dev/sdb1  # 修改最大挂载次数
```

#### 快照和备份

```bash
# 使用LVM创建快照
sudo lvcreate -s -L 1G -n mylv_snapshot /dev/myvg/mylv

# 挂载快照以访问
sudo mkdir /mnt/snapshot
sudo mount /dev/myvg/mylv_snapshot /mnt/snapshot

# 使用dd创建整个磁盘的镜像
sudo dd if=/dev/sda of=/path/to/disk.img bs=4M status=progress

# 使用rsync备份文件系统
sudo rsync -aAXv --exclude={"/dev/*","/proc/*","/sys/*","/tmp/*","/run/*","/mnt/*","/media/*"} / /mnt/backup/
```

## 进程管理

### 进程基础

#### 理解进程

```bash
# 查看当前终端的进程
ps

# 查看系统中的所有进程
ps aux

# 查看进程树
ps auxf
# 或使用pstree
pstree

# 查看特定用户的进程
ps -u username

# 查看特定进程及其子进程
ps -e --forest | grep processname
```

#### 进程详细信息

```bash
# 查看进程的详细信息
ps -p 1234 -f

# 查看进程的环境变量
cat /proc/1234/environ | tr '\0' '\n'

# 查看进程的命令行参数
cat /proc/1234/cmdline | tr '\0' ' '; echo

# 查看进程的内存映射
cat /proc/1234/maps

# 查看进程打开的文件
lsof -p 1234

# 查看进程的资源限制
cat /proc/1234/limits
```

### 进程监控与控制

#### 实时监控进程

```bash
# 使用top动态显示进程
top

# 使用htop（更友好的界面，可能需要安装）
htop

# top中的常用交互命令:
# P - 按CPU使用率排序
# M - 按内存使用率排序
# k - 杀死进程（提示输入PID）
# r - 重新调整进程优先级
# q - 退出
```

#### 进程控制

```bash
# 正常结束进程
kill 1234

# 强制终止进程
kill -9 1234

# 使用进程名称终止进程
pkill process_name

# 终止特定用户的所有进程
pkill -u username

# 发送其他信号
# SIGTERM (15) - 请求进程正常终止
kill -15 1234
# SIGHUP (1) - 通知进程配置已更改，常用于重载配置
kill -1 1234
# SIGKILL (9) - 强制终止进程，无法捕获或忽略
kill -9 1234

# 暂停进程
kill -STOP 1234

# 恢复暂停的进程
kill -CONT 1234
```

#### 后台作业控制

```bash
# 启动后台进程
command &

# 列出当前终端的后台作业
jobs

# 将前台运行的命令放入后台
# 按Ctrl+Z暂停前台进程，然后：
bg

# 将后台作业放回前台
fg %1  # 其中1是作业号

# 启动进程并在退出终端后继续运行
nohup command &

# 使用screen创建可分离的终端会话（需要安装）
screen
# 分离会话: Ctrl+a d
# 重新连接: screen -r
```

### 服务管理

#### systemd 服务管理（现代Linux发行版）

```bash
# 查看所有服务的状态
systemctl list-units --type=service

# 查看特定服务的状态
systemctl status nginx

# 启动服务
sudo systemctl start nginx

# 停止服务
sudo systemctl stop nginx

# 重启服务
sudo systemctl restart nginx

# 重新加载配置（不中断服务）
sudo systemctl reload nginx

# 启用开机自启
sudo systemctl enable nginx

# 禁用开机自启
sudo systemctl disable nginx

# 查看服务是否开机自启
systemctl is-enabled nginx
```

#### 服务配置与自定义

```bash
# 编辑现有服务配置
sudo systemctl edit nginx

# 创建新的systemd服务单元
sudo nano /etc/systemd/system/myservice.service

# 示例服务单元文件内容:
# [Unit]
# Description=My Custom Service
# After=network.target
#
# [Service]
# Type=simple
# User=myuser
# ExecStart=/usr/local/bin/my_program
# Restart=on-failure
#
# [Install]
# WantedBy=multi-user.target

# 重新加载systemd以识别新服务
sudo systemctl daemon-reload

# 启动并启用新服务
sudo systemctl start myservice
sudo systemctl enable myservice
```

### 资源限制与优先级

#### 监控系统资源

```bash
# 查看CPU信息
lscpu

# 查看内存使用情况
free -h
vmstat 1 5  # 每秒报告一次，共5次

# 查看I/O活动
iostat -x 1 5

# 全面系统监控（需要安装）
sudo apt install sysstat  # Ubuntu/Debian
sudo yum install sysstat  # CentOS/RHEL

# 使用sar监控系统活动
sar -u 1 5  # CPU使用情况
sar -r 1 5  # 内存使用情况
sar -b 1 5  # I/O活动
```

#### 进程优先级管理

```bash
# 查看进程的优先级（nice值）
ps -o pid,comm,nice -p 1234

# 启动新进程并设置优先级（较低）
nice -n 10 command

# 调整正在运行的进程优先级（较高，需要权限）
sudo renice -10 -p 1234

# 查看进程的CPU占用率
ps -o pid,%cpu,comm -p 1234
```

#### 限制进程资源

```bash
# 使用ulimit显示和设置资源限制
ulimit -a  # 显示所有限制

# 设置软限制（当前会话）
ulimit -n 2048  # 设置最大文件描述符数

# 永久设置限制（系统范围）
sudo nano /etc/security/limits.conf
# 添加类似以下的行:
# username soft nofile 2048
# username hard nofile 4096

# 使用cgroups限制资源使用（需要安装）
sudo apt install cgroup-tools  # Ubuntu/Debian
sudo yum install libcgroup-tools  # CentOS/RHEL

# 创建内存限制的cgroup
sudo cgcreate -g memory:limited
sudo cgset -r memory.limit_in_bytes=100M limited

# 在cgroup中运行命令
sudo cgexec -g memory:limited command
```

## 日志系统

### journalctl (systemd)

#### 基础用法

```bash
# 查看所有日志条目
journalctl

# 实时查看日志（类似tail -f）
journalctl -f

# 查看内核日志
journalctl -k

# 查看启动以来的日志
journalctl -b

# 查看特定时间范围的日志
journalctl --since "2023-01-01 00:00:00" --until "2023-01-02 00:00:00"

# 查看最近的日志
journalctl -n 50  # 最近50条日志
journalctl --since "1 hour ago"
```

#### 按服务和单元过滤

```bash
# 查看特定服务的日志
journalctl -u nginx.service

# 查看多个服务的日志
journalctl -u nginx.service -u php-fpm.service

# 查看特定进程ID的日志
journalctl _PID=1234

# 按优先级过滤日志
journalctl -p err  # 只显示错误及更严重的日志
```

#### 高级过滤和格式化

```bash
# 输出格式控制
journalctl -o json  # JSON格式
journalctl -o json-pretty  # 美化的JSON
journalctl -o verbose  # 详细输出

# 查看特定可执行文件的日志
journalctl /usr/bin/sshd

# 按用户ID过滤
journalctl _UID=1000

# 组合多种过滤条件
journalctl -u nginx.service --since today -p err

# 使用字段匹配
journalctl MESSAGE_ID=5eb03494a6d24b0cb3e34c77e29ded33
```

#### 日志管理与维护

```bash
# 查看日志占用的磁盘空间
journalctl --disk-usage

# 限制日志大小（设为1GB）
sudo journalctl --vacuum-size=1G

# 按时间清理日志
sudo journalctl --vacuum-time=1weeks

# 设置永久性日志大小限制
sudo mkdir -p /etc/systemd/journald.conf.d/
sudo nano /etc/systemd/journald.conf.d/00-journal-size.conf
# 添加以下内容:
# [Journal]
# SystemMaxUse=1G

# 重新加载配置
sudo systemctl restart systemd-journald
```

### 传统 syslog

#### rsyslog 基础

```bash
# 检查rsyslog服务状态
systemctl status rsyslog

# 查看主要日志文件
ls -l /var/log/syslog    # Ubuntu/Debian
ls -l /var/log/messages  # CentOS/RHEL

# 查看syslog配置
cat /etc/rsyslog.conf
ls -l /etc/rsyslog.d/

# 实时查看系统日志
tail -f /var/log/syslog    # Ubuntu/Debian
tail -f /var/log/messages  # CentOS/RHEL
```

#### 常见日志文件

```bash
# 系统日志
less /var/log/syslog    # Ubuntu/Debian
less /var/log/messages  # CentOS/RHEL

# 身份验证日志
less /var/log/auth.log  # Ubuntu/Debian
less /var/log/secure    # CentOS/RHEL

# 内核日志
less /var/log/kern.log  # Ubuntu/Debian
dmesg | less            # 所有发行版

# 应用程序特定日志
less /var/log/apache2/error.log  # Apache错误日志（Ubuntu/Debian）
less /var/log/httpd/error_log    # Apache错误日志（CentOS/RHEL）
less /var/log/nginx/error.log    # Nginx错误日志
```

#### 配置 rsyslog

```bash
# 编辑rsyslog配置
sudo nano /etc/rsyslog.conf

# 创建自定义日志配置
sudo nano /etc/rsyslog.d/myapp.conf

# 示例配置：将特定程序的日志写入单独文件
# 添加以下内容:
# :programname, isequal, "myapp" /var/log/myapp.log

# 重启rsyslog服务应用更改
sudo systemctl restart rsyslog
```

#### 使用 logger 命令

```bash
# 发送日志消息到syslog
logger "这是一条测试日志消息"

# 指定标识和优先级
logger -t myapp -p local0.info "应用程序初始化完成"

# 从文件输入日志
logger -f /path/to/file.txt

# 包含进程ID
logger -i "包含PID的消息"
```

### 日志轮转

#### logrotate 基础

```bash
# 查看logrotate配置
cat /etc/logrotate.conf
ls -l /etc/logrotate.d/

# 查看特定服务的日志轮转配置
cat /etc/logrotate.d/apache2  # Ubuntu/Debian
cat /etc/logrotate.d/httpd    # CentOS/RHEL

# 手动运行logrotate（调试）
sudo logrotate -d /etc/logrotate.conf  # 调试模式，不实际轮转
sudo logrotate -f /etc/logrotate.conf  # 强制执行轮转
```

#### 自定义 logrotate 配置

```bash
# 为自定义应用创建logrotate配置
sudo nano /etc/logrotate.d/myapp

# 示例配置内容
# /var/log/myapp/*.log {
#     daily
#     missingok
#     rotate 7
#     compress
#     delaycompress
#     notifempty
#     create 640 myappuser myappgroup
#     postrotate
#         systemctl reload myapp
#     endscript
# }

# 验证配置
sudo logrotate -d /etc/logrotate.d/myapp
```

#### journald 日志轮转

```bash
# journald的日志轮转是自动的，可以配置以下项:

# 编辑journald配置
sudo nano /etc/systemd/journald.conf

# 重要配置选项:
# MaxRetentionSec=   # 日志保留时间（例如：1month）
# MaxFileSec=        # 日志文件最大时间（例如：1day）
# SystemMaxUse=      # 日志最大磁盘使用量
# SystemKeepFree=    # 保持可用空间量

# 重启journald应用更改
sudo systemctl restart systemd-journald
```

### 日志分析与故障排查

#### 基本日志分析

```bash
# 查找错误消息
grep -i error /var/log/syslog
journalctl -p err

# 查找特定时间段的日志
grep "Jan 15 10:" /var/log/syslog
journalctl --since "2023-01-15 10:00:00" --until "2023-01-15 11:00:00"

# 按进程名称过滤
grep "sshd" /var/log/auth.log
journalctl -u sshd

# 统计特定消息出现次数
grep -c "Failed password" /var/log/auth.log

# 提取IP地址（例如从SSH登录失败日志）
grep "Failed password" /var/log/auth.log | grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b" | sort | uniq -c
```

#### 使用高级工具

```bash
# 日志分析工具（可能需要安装）
sudo apt install logwatch  # Ubuntu/Debian
sudo yum install logwatch  # CentOS/RHEL

# 生成日志报告
sudo logwatch --detail High --mailto user@example.com

# 使用goaccess分析Web服务器日志（需要安装）
sudo apt install goaccess  # Ubuntu/Debian
sudo yum install goaccess  # CentOS/RHEL
goaccess /var/log/apache2/access.log -c
```

#### 常见故障排查

```bash
# 系统启动问题
journalctl -b -p err

# 服务启动失败
systemctl status failed
journalctl -u failed_service.service

# 磁盘空间问题
df -h
journalctl --disk-usage
du -sh /var/log/*

# 内存问题
free -h
journalctl -u service_name | grep "out of memory"

# 安全问题（检查失败的登录尝试）
grep "Failed password" /var/log/auth.log
journalctl _SYSTEMD_UNIT=sshd.service | grep "Failed"

# 自定义监控脚本（检查SSH登录尝试）
#!/bin/bash
THRESHOLD=5
COUNT=$(grep "Failed password" /var/log/auth.log | grep -c "$(date +%b' '%d)")
if [ $COUNT -gt $THRESHOLD ]; then
  echo "警告：检测到 $COUNT 次失败的登录尝试！" | mail -s "安全警告" admin@example.com
fi
```

## 实战场景

### 场景1：服务器磁盘空间不足

```bash
# 1. 查找大文件和目录
sudo du -h --max-depth=1 /
sudo du -h --max-depth=1 /var
sudo find / -type f -size +100M -exec ls -lh {} \;

# 2. 检查日志文件是否过大
sudo ls -lh /var/log/
sudo journalctl --disk-usage

# 3. 清理日志文件
sudo journalctl --vacuum-time=1d  # 只保留1天的日志
sudo find /var/log -type f -name "*.gz" -delete  # 删除压缩的旧日志

# 4. 检查和清理软件包缓存
# Ubuntu/Debian
sudo apt clean
sudo apt autoremove

# CentOS/RHEL
sudo yum clean all
sudo package-cleanup --oldkernels --count=1

# 5. 寻找并删除临时文件
sudo find /tmp -type f -atime +10 -delete
sudo find /var/tmp -type f -atime +10 -delete

# 6. 使用ncdu进行交互式磁盘空间分析（需要安装）
sudo apt install ncdu  # Ubuntu/Debian
sudo yum install ncdu  # CentOS/RHEL
sudo ncdu /
```

### 场景2：排查CPU使用率高的问题

```bash
# 1. 查看整体系统负载
top
uptime

# 2. 识别高CPU使用率的进程
ps aux --sort=-%cpu | head -10

# 3. 查看特定进程的详细信息
ps -o pid,ppid,cmd,%cpu,%mem -p <PID>

# 4. 查看进程的线程使用情况
ps -eLo pid,ppid,tid,%cpu,comm --sort=-%cpu | grep <PID>

# 5. 检查是否存在异常进程
ps aux | grep '[d]efunct'  # 查找僵尸进程

# 6. 使用perf分析CPU热点（需要安装perf）
sudo apt install linux-tools-common linux-tools-generic  # Ubuntu/Debian
sudo yum install perf  # CentOS/RHEL
sudo perf top -p <PID>

# 7. 检查系统日志中的相关错误
journalctl -p err --since today
grep 'error\|warning' /var/log/syslog

# 8. 限制问题进程的CPU使用率
sudo cpulimit -p <PID> -l 50  # 限制为50%CPU（需要安装cpulimit）
```

### 场景3：分析并解决服务启动失败

```bash
# 1. 检查服务状态
sudo systemctl status problem-service.service

# 2. 查看详细的服务日志
journalctl -u problem-service.service

# 3. 检查配置文件语法
# 以nginx为例
sudo nginx -t

# 4. 查看服务的依赖状态
systemctl list-dependencies problem-service.service

# 5. 检查服务配置文件
cat /lib/systemd/system/problem-service.service
cat /etc/systemd/system/problem-service.service.d/*.conf  # 覆盖配置

# 6. 检查应用日志
tail -n 100 /var/log/problem-service/error.log

# 7. 尝试手动启动服务程序排查问题
sudo -u service_user /usr/bin/problem-service --config=/etc/problem-service/config.conf

# 8. 检查文件权限和所有权问题
ls -l /var/lib/problem-service/
ls -l /etc/problem-service/config.conf

# 9. 检查系统资源是否充足
free -h
df -h

# 10. 修复并重启服务
sudo systemctl daemon-reload  # 重新加载systemd配置
sudo systemctl restart problem-service.service
```

### 场景4：监控和分析系统性能

```bash
# 1. 设置基本性能监控
# 安装监控工具
sudo apt install sysstat atop iotop  # Ubuntu/Debian
sudo yum install sysstat atop iotop  # CentOS/RHEL

# 2. 启用sysstat数据收集
sudo systemctl enable sysstat
sudo systemctl start sysstat

# 3. 创建一个性能数据收集脚本
cat > collect_performance.sh << 'EOF'
#!/bin/bash
OUTDIR="/var/log/performance/$(date +%Y-%m-%d)"
mkdir -p $OUTDIR

# 收集CPU、内存、I/O和网络数据
sar -o $OUTDIR/cpu.sar -u 5 12 &
sar -o $OUTDIR/mem.sar -r 5 12 &
sar -o $OUTDIR/io.sar -b 5 12 &
sar -o $OUTDIR/net.sar -n DEV 5 12 &

# 收集进程信息
ps aux --sort=-%cpu | head -20 > $OUTDIR/top_cpu.txt
ps aux --sort=-%mem | head -20 > $OUTDIR/top_mem.txt

# 收集磁盘使用情况
df -h > $OUTDIR/disk_usage.txt
EOF
chmod +x collect_performance.sh

# 4. 设置cron作业定期收集数据
sudo crontab -e
# 添加以下行以每小时运行一次
# 0 * * * * /path/to/collect_performance.sh

# 5. 分析收集的性能数据
sar -f /var/log/performance/2023-01-15/cpu.sar

# 6. 根据分析结果解决问题
# 例如：如果发现I/O是瓶颈
sudo iotop -b -n 5  # 识别I/O重度使用者
```

### 场景5：安全审计和入侵检测

```bash
# 1. 检查可疑的登录尝试
grep "Failed password" /var/log/auth.log | tail -n 50

# 2. 查找成功的SSH登录
grep "Accepted" /var/log/auth.log

# 3. 检查当前登录的用户
who
w

# 4. 监控新建的用户和组
grep -e "useradd\|groupadd" /var/log/auth.log

# 5. 检查异常的进程
ps aux | grep -v "^$(whoami)"  # 显示不属于当前用户的进程

# 6. 检查异常的网络连接
sudo netstat -tulpn | grep ESTABLISHED
sudo lsof -i  # 显示所有网络连接

# 7. 检查定时任务
crontab -l
sudo ls -l /etc/cron.*

# 8. 检查启动服务
systemctl list-unit-files --state=enabled

# 9. 创建入侵检测报告脚本
cat > security_audit.sh << 'EOF'
#!/bin/bash
REPORT="/var/log/security/audit-$(date +%Y-%m-%d).log"
mkdir -p $(dirname $REPORT)

echo "=== 安全审计报告: $(date) ===" > $REPORT
echo "" >> $REPORT

echo "== 失败的登录尝试 ==" >> $REPORT
grep "Failed password" /var/log/auth.log | tail -n 20 >> $REPORT
echo "" >> $REPORT

echo "== 成功的SSH登录 ==" >> $REPORT
grep "Accepted" /var/log/auth.log | tail -n 10 >> $REPORT
echo "" >> $REPORT

echo "== 当前登录用户 ==" >> $REPORT
who >> $REPORT
echo "" >> $REPORT

echo "== 最近添加的用户账户 ==" >> $REPORT
grep -e "useradd\|groupadd" /var/log/auth.log | tail -n 10 >> $REPORT
echo "" >> $REPORT

echo "== 可疑进程 ==" >> $REPORT
ps aux | grep "^\S\+\s\+[0-9]\+\s\+[0-9.]\+\s\+[0-9.]\+\s\+" | sort -n -k 3 | tail -n 15 >> $REPORT
echo "" >> $REPORT

echo "== 可疑网络连接 ==" >> $REPORT
netstat -tulpn | grep ESTABLISHED >> $REPORT
echo "" >> $REPORT

echo "== 端口监听情况 ==" >> $REPORT
netstat -tulpn | grep LISTEN >> $REPORT
EOF
chmod +x security_audit.sh

# 10. 设置每日安全审计
sudo crontab -e
# 添加以下行以每天凌晨3点运行审计
# 0 3 * * * /path/to/security_audit.sh
```

### 场景6：系统日志分析和警报设置

```bash
# 1. 创建一个日志分析脚本
cat > analyze_logs.sh << 'EOF'
#!/bin/bash

LOG_DIR="/var/log"
EMAIL="admin@example.com"
ALERT_LOG="/tmp/system_alerts.log"

echo "系统日志分析报告: $(date)" > $ALERT_LOG

# 检查认证失败
echo -e "\n== 认证失败 ==" >> $ALERT_LOG
grep "Failed password" $LOG_DIR/auth.log | tail -n 10 >> $ALERT_LOG

# 检查系统错误
echo -e "\n== 系统错误 ==" >> $ALERT_LOG
journalctl -p err --since "1 hour ago" | tail -n 20 >> $ALERT_LOG

# 检查磁盘空间警告
echo -e "\n== 磁盘空间 ==" >> $ALERT_LOG
df -h | awk '$5 > "80%" {print}' >> $ALERT_LOG

# 检查高CPU进程
echo -e "\n== 高CPU进程 ==" >> $ALERT_LOG
ps aux | sort -nr -k 3 | head -10 >> $ALERT_LOG

# 检查高内存进程
echo -e "\n== 高内存进程 ==" >> $ALERT_LOG
ps aux | sort -nr -k 4 | head -10 >> $ALERT_LOG

# 发送邮件警报（如果找到问题）
if grep -q -e "Failed password" -e "error" -e "warning" -e "9[0-9]%" $ALERT_LOG; then
    cat $ALERT_LOG | mail -s "系统警报: $(hostname)" $EMAIL
fi
EOF
chmod +x analyze_logs.sh

# 2. 设置定时运行
sudo crontab -e
# 添加以下行以每小时运行一次
# 0 * * * * /path/to/analyze_logs.sh

# 3. 创建实时日志监控脚本
cat > monitor_logs.sh << 'EOF'
#!/bin/bash

LOG_FILE="/var/log/syslog"
PATTERNS=(
    "error"
    "critical"
    "failed"
    "segfault"
    "out of memory"
)

# 用tail -f监控日志并用grep过滤关键词
tail -f $LOG_FILE | grep -i --color=always -E "$(IFS="|"; echo "${PATTERNS[*]}")"
EOF
chmod +x monitor_logs.sh

# 4. 使用logcheck自动监控（需要安装）
sudo apt install logcheck  # Ubuntu/Debian
sudo yum install logcheck  # CentOS/RHEL
sudo nano /etc/logcheck/logcheck.conf  # 配置邮件和检查间隔
```

# 
