# Linux 命令行操作完全指南：从入门到实战

## 目录
1. [基础命令操作](#基础命令操作)
2. [包管理](#包管理)
   - [apt (Ubuntu/Debian)](#apt-ubuntu-debian)
   - [yum (CentOS/RHEL)](#yum-centos-rhel)
3. [用户权限管理](#用户权限管理)
4. [网络调试工具](#网络调试工具)
5. [实战场景](#实战场景)

## 基础命令操作

### 导航和文件操作

#### 目录导航
```bash
# 显示当前目录
pwd

# 列出文件和目录
ls
ls -l    # 详细信息
ls -la   # 包括隐藏文件
ls -lh   # 以人类可读的格式显示文件大小

# 切换目录
cd /path/to/directory
cd ~     # 回到主目录
cd ..    # 返回上一级目录
cd -     # 返回上一个工作目录
```

#### 文件操作
```bash
# 创建文件
touch file.txt

# 创建目录
mkdir new_directory
mkdir -p parent/child/grandchild  # 创建嵌套目录

# 复制文件
cp file.txt backup_file.txt
cp -r directory/ backup_directory/  # 复制整个目录

# 移动或重命名文件
mv file.txt new_name.txt
mv file.txt /path/to/destination/

# 删除文件和目录
rm file.txt
rm -i file.txt  # 删除前提示确认
rm -r directory/  # 递归删除目录及其内容
rm -rf directory/  # 强制递归删除（谨慎使用！）
```

### 查看和编辑文件

```bash
# 查看文件内容
cat file.txt
less file.txt  # 分页查看
head -n 10 file.txt  # 查看前10行
tail -n 20 file.txt  # 查看后20行
tail -f log_file.txt  # 实时查看更新的日志

# 文本编辑器
nano file.txt  # 适合初学者的简单编辑器
vim file.txt   # 强大的文本编辑器（需要学习特定命令）
```

### 文件搜索和过滤

```bash
# 在文件中搜索内容
grep "search_term" file.txt
grep -i "search_term" file.txt  # 忽略大小写
grep -r "search_term" directory/  # 递归搜索目录

# 查找文件
find /path/to/search -name "filename"
find /home -type f -name "*.txt"  # 查找所有txt文件
find /var/log -type f -mtime -7   # 查找7天内修改的文件

# 过滤和管道
cat file.txt | grep "error"  # 显示包含"error"的行
ls -l | grep "^d"           # 只列出目录
```

## 包管理

### apt (Ubuntu/Debian)

#### 基础操作

```bash
# 更新软件包列表
sudo apt update

# 升级所有已安装的包
sudo apt upgrade

# 安装软件包
sudo apt install package_name
sudo apt install package1 package2 package3  # 安装多个软件包

# 移除软件包
sudo apt remove package_name
sudo apt purge package_name  # 移除软件包及其配置文件

# 搜索软件包
apt search keyword

# 查看软件包信息
apt show package_name
```

#### 高级操作

```bash
# 只升级安全更新
sudo apt upgrade --security

# 列出可升级的包
apt list --upgradable

# 自动移除不再需要的依赖
sudo apt autoremove

# 清理本地缓存的软件包
sudo apt clean
sudo apt autoclean  # 只清理不能下载的软件包

# 从特定源安装软件包
sudo add-apt-repository ppa:user/repository
sudo apt update
sudo apt install package_name
```

### yum (CentOS/RHEL)

#### 基础操作

```bash
# 更新所有软件包
sudo yum update

# 安装软件包
sudo yum install package_name
sudo yum install package1 package2  # 安装多个软件包

# 移除软件包
sudo yum remove package_name

# 搜索软件包
yum search keyword

# 查看软件包信息
yum info package_name
```

#### 高级操作

```bash
# 列出所有可用的软件包组
yum grouplist

# 安装软件包组
sudo yum groupinstall "Development Tools"

# 仅下载但不安装软件包
sudo yum install --downloadonly --downloaddir=/path/to/dir package_name

# 查看软件仓库信息
yum repolist

# 清理缓存
sudo yum clean all
```

#### DNF (CentOS 8及更新版本)

```bash
# 更新所有软件包
sudo dnf update

# 安装软件包
sudo dnf install package_name

# 切换软件版本
sudo dnf module list
sudo dnf module enable php:7.4  # 启用PHP 7.4
sudo dnf install php
```

## 用户权限管理

### 用户和组管理

#### 用户操作

```bash
# 创建新用户
sudo useradd username
sudo useradd -m -s /bin/bash username  # 创建带有home目录和bash shell的用户

# 设置用户密码
sudo passwd username

# 修改用户信息
sudo usermod -aG group username  # 将用户添加到组
sudo usermod -s /bin/bash username  # 更改用户的默认shell

# 删除用户
sudo userdel username
sudo userdel -r username  # 同时删除用户的home目录和邮件
```

#### 组操作

```bash
# 创建新组
sudo groupadd groupname

# 修改组信息
sudo groupmod -n new_name old_name  # 重命名组

# 删除组
sudo groupdel groupname

# 查看用户和组信息
id username
groups username  # 查看用户所属的组
```

### 文件权限管理

#### 基本权限

```bash
# 查看文件权限
ls -l file.txt

# 修改文件权限
chmod 755 file.txt  # 数字表示法：rwxr-xr-x
chmod u+x file.txt  # 符号表示法：给所有者添加执行权限
chmod g-w,o-w file.txt  # 从组和其他用户移除写权限
chmod -R 755 directory/  # 递归设置权限

# 修改文件所有者
sudo chown username file.txt
sudo chown username:groupname file.txt  # 同时更改所有者和组
sudo chown -R username:groupname directory/  # 递归更改所有权
```

#### 特殊权限

```bash
# 设置SUID权限（执行时以文件所有者权限）
chmod u+s file.txt
chmod 4755 file.txt

# 设置SGID权限（执行时以文件所属组权限）
chmod g+s directory/
chmod 2755 directory/

# 设置粘滞位（只有所有者才能删除文件）
chmod +t directory/
chmod 1777 directory/
```

#### ACL权限（访问控制列表）

```bash
# 查看文件的ACL
getfacl file.txt

# 设置ACL
setfacl -m u:username:rwx file.txt  # 给特定用户设置权限
setfacl -m g:groupname:rx file.txt  # 给特定组设置权限
setfacl -R -m u:username:rwx directory/  # 递归设置

# 移除ACL
setfacl -x u:username file.txt  # 移除特定用户的ACL
setfacl -b file.txt  # 移除所有ACL
```

### sudo 权限管理

```bash
# 编辑sudoers文件
sudo visudo

# 示例配置
# username ALL=(ALL:ALL) ALL  # 允许用户执行任何命令
# username ALL=(ALL:ALL) NOPASSWD: ALL  # 无需输入密码
# %groupname ALL=(ALL:ALL) ALL  # 允许组中所有用户执行任何命令

# 列出当前用户的sudo权限
sudo -l
```

## 网络调试工具

### 基本网络命令

```bash
# 查看网络接口
ifconfig
ip addr show  # 现代Linux推荐使用

# 测试连通性
ping google.com
ping -c 4 192.168.1.1  # 发送4个数据包

# DNS查询
host google.com
dig google.com
nslookup google.com

# 路由信息
route
ip route show  # 现代Linux推荐使用
traceroute google.com  # 显示到目标的路径
```

### netstat 命令

```bash
# 列出所有监听端口
netstat -tuln
# -t: TCP协议
# -u: UDP协议
# -l: 仅显示监听中的端口
# -n: 显示数字而非主机名和服务名

# 显示与特定端口相关的连接
netstat -an | grep ':80'  # 显示与80端口相关的所有连接

# 显示进程信息
netstat -tulnp  # 需要root权限显示进程ID和名称
netstat -tulnpe  # 额外显示用户信息

# 显示路由表
netstat -r
```

### ss 命令（netstat的现代替代品）

```bash
# 列出所有监听端口
ss -tuln

# 显示与特定端口相关的连接
ss -an | grep ':80'

# 显示进程信息
ss -tulnp

# 显示详细统计信息
ss -s

# 显示特定状态的连接
ss -o state established
ss -o state time-wait
```

### iptables 防火墙管理

#### 基本操作

```bash
# 查看当前防火墙规则
sudo iptables -L -n -v
# -L: 列出规则
# -n: 数字输出
# -v: 显示详细信息

# 添加基本规则
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT  # 允许SSH连接
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT  # 允许HTTP连接

# 默认策略
sudo iptables -P INPUT DROP  # 默认丢弃所有进入的包
sudo iptables -P FORWARD DROP
sudo iptables -P OUTPUT ACCEPT  # 默认允许所有出去的包

# 删除规则
sudo iptables -D INPUT 1  # 删除INPUT链中的第一条规则
```

#### 高级示例

```bash
# 允许已建立和相关的连接
sudo iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 允许本地回环接口
sudo iptables -A INPUT -i lo -j ACCEPT

# 阻止特定IP地址
sudo iptables -A INPUT -s 192.168.1.100 -j DROP

# 限制连接速率（防止DoS攻击）
sudo iptables -A INPUT -p tcp --dport 80 -m limit --limit 20/minute --limit-burst 100 -j ACCEPT

# 保存规则
# Ubuntu/Debian
sudo netfilter-persistent save

# CentOS/RHEL
sudo service iptables save
```

### firewalld 管理（CentOS 7及更新版本）

```bash
# 检查服务状态
sudo systemctl status firewalld

# 获取默认区域
sudo firewall-cmd --get-default-zone

# 列出所有规则
sudo firewall-cmd --list-all

# 添加服务或端口
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-port=8080/tcp

# 重载配置
sudo firewall-cmd --reload

# 允许特定IP访问特定端口
sudo firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="192.168.1.100" port port=22 protocol=tcp accept'
```

## 实战场景

### 场景1：服务器初始化配置

```bash
# 1. 更新系统并安装基础工具
sudo apt update && sudo apt upgrade -y  # Ubuntu
# 或
sudo yum update -y  # CentOS

sudo apt install -y vim curl wget htop git unzip  # Ubuntu
# 或
sudo yum install -y vim curl wget htop git unzip  # CentOS

# 2. 创建非root用户并配置sudo权限
sudo useradd -m -s /bin/bash webadmin
sudo passwd webadmin
sudo usermod -aG sudo webadmin  # Ubuntu
# 或
sudo usermod -aG wheel webadmin  # CentOS

# 3. 配置SSH安全
sudo vim /etc/ssh/sshd_config
# 修改以下设置:
# PermitRootLogin no
# PasswordAuthentication no
# Port 2222  # 自定义SSH端口

# 4. 重启SSH服务
sudo systemctl restart sshd

# 5. 配置防火墙
sudo ufw allow 2222/tcp  # Ubuntu
sudo ufw enable

# 或者CentOS:
sudo firewall-cmd --permanent --add-port=2222/tcp
sudo firewall-cmd --reload
```

### 场景2：Web服务器配置和监控

```bash
# 1. 安装Nginx服务器
sudo apt install -y nginx  # Ubuntu
# 或
sudo yum install -y epel-release
sudo yum install -y nginx  # CentOS

# 2. 配置基本网站
sudo vim /etc/nginx/sites-available/mywebsite  # Ubuntu
# 或
sudo vim /etc/nginx/conf.d/mywebsite.conf  # CentOS

# 3. 创建软链接（仅Ubuntu需要）
sudo ln -s /etc/nginx/sites-available/mywebsite /etc/nginx/sites-enabled/

# 4. 测试配置并重启Nginx
sudo nginx -t
sudo systemctl restart nginx

# 5. 监控Nginx访问日志
sudo tail -f /var/log/nginx/access.log

# 6. 查看服务器负载
htop

# 7. 检查Nginx连接数
sudo ss -tan | grep ":80" | wc -l  # 统计80端口的连接数

# 8. 防火墙设置
sudo ufw allow 'Nginx Full'  # Ubuntu
# 或
sudo firewall-cmd --permanent --add-service=http --add-service=https  # CentOS
sudo firewall-cmd --reload
```

### 场景3：数据库服务器配置

```bash
# 1. 安装MySQL/MariaDB
sudo apt install -y mariadb-server  # Ubuntu
# 或
sudo yum install -y mariadb-server  # CentOS

# 2. 启动并设置开机自启
sudo systemctl start mariadb
sudo systemctl enable mariadb

# 3. 初始安全设置
sudo mysql_secure_installation

# 4. 创建数据库和用户
sudo mysql -u root -p
```

```sql
CREATE DATABASE myapp;
CREATE USER 'appuser'@'localhost' IDENTIFIED BY 'strongpassword';
GRANT ALL PRIVILEGES ON myapp.* TO 'appuser'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

```bash
# 5. 配置远程访问（谨慎操作）
sudo vim /etc/mysql/mariadb.conf.d/50-server.cnf  # Ubuntu
# 或
sudo vim /etc/my.cnf.d/server.cnf  # CentOS
# 将bind-address = 127.0.0.1改为bind-address = 0.0.0.0

# 6. 重启服务
sudo systemctl restart mariadb

# 7. 检查数据库连接
sudo ss -tunlp | grep mysql

# 8. 防火墙配置
sudo ufw allow 3306/tcp  # Ubuntu
# 或
sudo firewall-cmd --permanent --add-port=3306/tcp  # CentOS
sudo firewall-cmd --reload
```

### 场景4：系统性能问题排查

```bash
# 1. 实时查看系统负载
top
# 或推荐使用
htop

# 2. 查看内存使用情况
free -h

# 3. 查看磁盘使用情况
df -h
du -sh /var/log/*  # 检查日志目录大小

# 4. 查看CPU信息和使用率
lscpu
mpstat -P ALL 2 5  # 每2秒显示一次，显示5次

# 5. 识别高CPU使用的进程
ps aux --sort=-%cpu | head -10

# 6. 识别高内存使用的进程
ps aux --sort=-%mem | head -10

# 7. 查看网络连接状况
ss -s  # 网络连接统计
netstat -i  # 网络接口统计

# 8. 检查系统日志
sudo tail -f /var/log/syslog  # Ubuntu
# 或
sudo tail -f /var/log/messages  # CentOS

# 9. I/O性能监控
sudo iostat -xz 2

# 10. 网络带宽监控（需要安装）
sudo apt install -y iftop  # Ubuntu
# 或
sudo yum install -y iftop  # CentOS
sudo iftop -i eth0
```

### 场景5：自动化备份脚本

创建一个MySQL数据库备份脚本：

```bash
#!/bin/bash

# 变量设置
BACKUP_DIR="/var/backups/mysql"
DATE=$(date +%Y-%m-%d_%H-%M-%S)
MYSQL_USER="backup_user"
MYSQL_PASSWORD="backup_password"
RETENTION_DAYS=7

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份所有数据库
mysqldump -u$MYSQL_USER -p$MYSQL_PASSWORD --all-databases | gzip > $BACKUP_DIR/all_databases_$DATE.sql.gz

# 删除旧备份
find $BACKUP_DIR -name "*.sql.gz" -type f -mtime +$RETENTION_DAYS -delete

# 记录备份结果
echo "Backup completed at $DATE" >> $BACKUP_DIR/backup_log.txt
```

将此脚本保存为`backup_mysql.sh`，然后设置执行权限：

```bash
sudo chmod +x backup_mysql.sh
```

添加到crontab以每天凌晨3点自动执行：

```bash
sudo crontab -e
# 添加以下行
0 3 * * * /path/to/backup_mysql.sh
```

### 场景6：网络故障排查

```bash
# 1. 检查网络接口状态
ip link show
# 或
ifconfig

# 2. 验证IP地址配置
ip addr show
# 检查特定接口
ip addr show eth0

# 3. 测试本地网络连通性
ping 127.0.0.1
ping 本机IP地址

# 4. 测试网关连通性
ip route | grep default  # 找到默认网关
ping 默认网关IP

# 5. 测试DNS解析
ping google.com
# 如果失败，检查DNS设置
cat /etc/resolv.conf

# 6. 测试DNS解析详情
dig google.com
# 或
nslookup google.com

# 7. 查看路由表
ip route show
# 或
route -n

# 8. 追踪到目标的路径
traceroute google.com
# 或
mtr google.com  # 需要安装mtr包

# 9. 检查特定服务端口是否开放
nc -zv google.com 443
# 或
telnet google.com 443

# 10. 检查本机监听端口
ss -tuln
# 或
netstat -tuln

# 11. 检查防火墙规则
sudo iptables -L -n -v  # iptables
# 或
sudo firewall-cmd --list-all  # firewalld

# 12. 检查网络配置文件
cat /etc/network/interfaces  # Ubuntu
# 或
cat /etc/sysconfig/network-scripts/ifcfg-eth0  # CentOS
```

## 总结

本指南提供了Linux常用发行版的命令行操作、包管理、用户权限和网络调试的详细示例。通过这些循序渐进的练习，你可以从Linux小白成长为能够处理实际系统管理和维护任务的用户。记住，熟能生巧，多练习这些命令会让你更加熟悉Linux环境，成为更高效的系统管理员。
```